I. SQL
======

Задачи, приведенные ниже, рекомендуется решить с помощью стандартного (либо в нотации Postgres) SQL с минимальным числом подзапросов. Ответы подразумеваются в виде SQL-запросов к таблице.

Исходная таблица клиентских транзакций:

tr (
  client_id bigint,   -- id клиента
  type_id integer,    -- id типа транзакции
  amount numeric,     -- сумма транзакции
  dttm timestamp      -- таймстамп (дата+время) транзакции
);

Для каждой комбинации {client_id, dttm} в таблице есть только одна запись.

Необходимо:

1. По каждому клиенту найти максимальную сумму транзакции с type_id=1 за текущий месяц, дополнив выборку полем с максимальной суммой транзакции этого типа за месяц, соответствующий текущему в прошлом году.

2. По каждому клиенту нужно выбрать последнюю транзакцию каждого типа.

3. По каждому клиенту выбрать транзакции, сумма которых превышает сумму последней транзакции данного типа для данного клиента.

4. Посчитать среднемесячную сумму транзакций в разрезе клиентов отдельно по каждому типу транзакции.

5. Посчитать агрегат с суммой транзакций всех типов нарастающим итогом (с первого дня месяца) в разрезе клиентов по дням.

6. Выбрать данные из таблицы за текущий месяц, дополнив их номером транзакции в разрезе клиентов, который начинается с единицы и увеличивается на один в порядке возрастания dttm.

7. Условия те же, что в п. 6, только номер транзакции нужно дополнительно сбрасывать в единицу каждый раз, когда сумма меньше десяти.



II. Python, pandas
==================

Вопрос 1.

Дано: DataFrame вида
df = pd.DataFrame(
    data=[[1, 2, "3"], [4, 5, "6"], [7, 8, "9"]],
    columns=list("abc"),
    index=["I", "II", "III"]
)

Нужно записать следующий код (два варианта) одной строкой.

вариант 1.

df["d"] = 0

for index, row in df.iterrows():
    row_sum = 0
    for num, item in enumerate(row):
        if isinstance(item, int):
            row_sum += item
    df.loc[index, "d"] = row_sum

вариант 2.

for index, row in df.iterrows():
    for num, item in enumerate(row):
        df.loc[index, "b"] = "item " + str(item)


Вопрос 2.

Сделать любой пункт из раздела I (SQL) на пандасе. Для простоты можно считать, что в пандасе уже есть исходный датафрейм df_tr, идентичный по структуре и данным реляционной таблице tr, а результат достаточно сохранить в локальный файл tr_output.csv.
